{
  "name": "PME Dakar â€” Classification + Actions Automatiques",
  "nodes": [
    {
      "parameters": {
        "formTitle": "ğŸ“© SupÃ©rette Dakar â€” Envoyez votre demande",
        "formDescription": "Nous traitons votre message automatiquement et vous rÃ©pondons rapidement.",
        "formFields": {
          "values": [
            {
              "fieldLabel": "nom",
              "fieldType": "text",
              "requiredField": true,
              "placeholder": "Ex : Amadou Diallo"
            },
            {
              "fieldLabel": "email",
              "fieldType": "email",
              "requiredField": true,
              "placeholder": "Ex : amadou@email.sn"
            },
            {
              "fieldLabel": "telephone",
              "fieldType": "text",
              "requiredField": false,
              "placeholder": "Ex : +221 77 000 00 00"
            },
            {
              "fieldLabel": "texte",
              "fieldType": "textarea",
              "requiredField": true,
              "placeholder": "Ex : Avez-vous du riz parfumÃ© en stock ?"
            }
          ]
        },
        "responseMode": "lastNode",
        "options": {}
      },
      "id": "node_01_form",
      "name": "ğŸ“¥ Formulaire Client",
      "type": "n8n-nodes-base.formTrigger",
      "typeVersion": 2.2,
      "position": [
        -900,
        0
      ],
      "webhookId": "pme-dakar-simple"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "nom",
              "name": "nom",
              "value": "={{ $json['nom'] }}",
              "type": "string"
            },
            {
              "id": "email",
              "name": "email",
              "value": "={{ $json['email'] }}",
              "type": "string"
            },
            {
              "id": "telephone",
              "name": "telephone",
              "value": "={{ $json['telephone'] || '' }}",
              "type": "string"
            },
            {
              "id": "texte",
              "name": "texte",
              "value": "={{ $json['texte'] }}",
              "type": "string"
            },
            {
              "id": "req_id",
              "name": "req_id",
              "value": "=REQ-{{ new Date().getTime() }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "node_02_extract",
      "name": "ğŸ”§ Extraire Champs",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -660,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "VOTRE_URL_NGROK/predict",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "message",
              "value": "={{ $json.texte }}"
            }
          ]
        },
        "options": {}
      },
      "id": "node_03_ml",
      "name": "ğŸ¤– Classifier ML",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -420,
        0
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "nom",
              "name": "nom",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.nom }}",
              "type": "string"
            },
            {
              "id": "email",
              "name": "email",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.email }}",
              "type": "string"
            },
            {
              "id": "telephone",
              "name": "telephone",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.telephone }}",
              "type": "string"
            },
            {
              "id": "texte",
              "name": "texte",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.texte }}",
              "type": "string"
            },
            {
              "id": "req_id",
              "name": "req_id",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.req_id }}",
              "type": "string"
            },
            {
              "id": "timestamp",
              "name": "timestamp",
              "value": "={{ $('ğŸ”§ Extraire Champs').item.json.timestamp }}",
              "type": "string"
            },
            {
              "id": "classe",
              "name": "classe",
              "value": "={{ $json.classe }}",
              "type": "string"
            },
            {
              "id": "confiance",
              "name": "confiance",
              "value": "={{ $json.confiance }}",
              "type": "number"
            },
            {
              "id": "reponse",
              "name": "reponse_client",
              "value": "={{ $json.reponse_client }}",
              "type": "string"
            },
            {
              "id": "action",
              "name": "action",
              "value": "={{ $json.action_automatique }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "id": "node_04_merge",
      "name": "ğŸ“ Fusionner DonnÃ©es",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.3,
      "position": [
        -180,
        0
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.classe }}",
              "rightValue": "Urgence",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "node_05_if_urgence",
      "name": "ğŸš¨ Urgence ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        80,
        -200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.classe }}",
              "rightValue": "RÃ©clamation",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "node_06_if_reclamation",
      "name": "âš ï¸ RÃ©clamation ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        80,
        0
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true
          },
          "conditions": [
            {
              "leftValue": "={{ $json.classe }}",
              "rightValue": "Commande",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ]
        }
      },
      "id": "node_07_if_commande",
      "name": "ğŸ›’ Commande ?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        80,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// ACTION URGENCE â€” Notification immÃ©diate responsable\nconst d = $input.first().json;\nreturn [{ json: {\n  ...d,\n  label: 'ğŸš¨ URGENCE',\n  sujet_email: 'ğŸš¨ [URGENT] ' + d.req_id + ' â€” ' + d.nom,\n  corps_email: 'ALERTE URGENTE\\n\\nID : ' + d.req_id + '\\nClient : ' + d.nom + '\\nContact : ' + d.email + ' / ' + d.telephone + '\\nDate : ' + d.timestamp + '\\n\\nMessage client :\\n\"' + d.texte + '\"\\n\\nConfiance ML : ' + d.confiance + '%\\n\\nâš¡ INTERVENTION IMMÃ‰DIATE REQUISE',\n  destinataire: 'responsable@superette-dakar.sn',\n  reponse_finale: d.reponse_client\n}}];"
      },
      "id": "node_08_urgence",
      "name": "ğŸš¨ PrÃ©parer Urgence",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        340,
        -320
      ]
    },
    {
      "parameters": {
        "jsCode": "// ACTION RÃ‰CLAMATION â€” Ticket + transfert service client\nconst d = $input.first().json;\nconst ticket = 'REC-' + Date.now();\nreturn [{ json: {\n  ...d,\n  label: 'âš ï¸ RÃ‰CLAMATION',\n  ticket: ticket,\n  sujet_email: 'âš ï¸ [RÃ‰CLAMATION] Ticket ' + ticket + ' â€” ' + d.nom,\n  corps_email: 'NOUVELLE RÃ‰CLAMATION\\n\\nTicket : ' + ticket + '\\nID : ' + d.req_id + '\\nClient : ' + d.nom + '\\nContact : ' + d.email + ' / ' + d.telephone + '\\nDate : ' + d.timestamp + '\\n\\nMessage client :\\n\"' + d.texte + '\"\\n\\nConfiance ML : ' + d.confiance + '%\\n\\nâ†’ Traitement sous 24h requis',\n  destinataire: 'service-client@superette-dakar.sn',\n  reponse_finale: d.reponse_client\n}}];"
      },
      "id": "node_09_reclamation",
      "name": "âš ï¸ PrÃ©parer RÃ©clamation",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        340,
        -100
      ]
    },
    {
      "parameters": {
        "jsCode": "// ACTION COMMANDE â€” Enregistrement + notification stock\nconst d = $input.first().json;\nconst cmd = 'CMD-' + Date.now();\nreturn [{ json: {\n  ...d,\n  label: 'ğŸ›’ COMMANDE',\n  numero_cmd: cmd,\n  sujet_email: 'ğŸ›’ [COMMANDE] ' + cmd + ' â€” ' + d.nom,\n  corps_email: 'NOUVELLE COMMANDE\\n\\nCommande : ' + cmd + '\\nID : ' + d.req_id + '\\nClient : ' + d.nom + '\\nContact : ' + d.email + ' / ' + d.telephone + '\\nDate : ' + d.timestamp + '\\n\\nMessage client :\\n\"' + d.texte + '\"\\n\\nConfiance ML : ' + d.confiance + '%\\n\\nâ†’ Confirmer disponibilitÃ© et dÃ©lai de livraison',\n  destinataire: 'stock@superette-dakar.sn',\n  reponse_finale: d.reponse_client\n}}];"
      },
      "id": "node_10_commande",
      "name": "ğŸ›’ PrÃ©parer Commande",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        340,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "// ACTION INFORMATION â€” RÃ©ponse automatique uniquement\nconst d = $input.first().json;\nreturn [{ json: {\n  ...d,\n  label: 'â„¹ï¸ INFORMATION',\n  sujet_email: null,\n  corps_email: null,\n  destinataire: null,\n  reponse_finale: d.reponse_client\n}}];"
      },
      "id": "node_11_information",
      "name": "â„¹ï¸ PrÃ©parer Information",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        340,
        340
      ]
    },
    {
      "parameters": {
        "fromEmail": "contact@superette-dakar.sn",
        "toEmail": "={{ $json.destinataire }}",
        "subject": "={{ $json.sujet_email }}",
        "emailFormat": "text",
        "text": "={{ $json.corps_email }}",
        "options": {}
      },
      "id": "node_12_email_interne",
      "name": "ğŸ“§ Email Responsable",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        600,
        -210
      ],
      "credentials": {
        "smtp": {
          "id": "VOTRE_CREDENTIAL_SMTP_ID",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nconst now = new Date(data.timestamp);\nconst dateStr = now.toLocaleDateString('fr-FR');\nconst timeStr = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });\n\nconst esc = (v) => {\n  const s = String(v || '').replace(/\"/g, '\"\"');\n  return (s.includes(',') || s.includes('\"') || s.includes('\\n')) ? `\"${s}\"` : s;\n};\n\nconst headers = 'ID,Date,Heure,Nom,Email,TÃ©lÃ©phone,Classe ML,Confiance (%),Message,Action,Statut';\nconst row = [\n  data.req_id,\n  dateStr,\n  timeStr,\n  data.nom,\n  data.email,\n  data.telephone,\n  data.classe,\n  data.confiance,\n  data.texte,\n  data.label,\n  'TraitÃ©'\n].map(esc).join(',');\n\nconst csvContent = '\\uFEFF' + headers + '\\n' + row + '\\n';\nconst binaryData = await this.helpers.prepareBinaryData(\n  Buffer.from(csvContent, 'utf8'),\n  'historique_demandes.csv',\n  'text/csv'\n);\n\nreturn [{\n  json: { success: true, req_id: data.req_id },\n  binary: { data: binaryData }\n}];"
      },
      "id": "node_13_csv",
      "name": "ğŸ’¾ PrÃ©parer CSV",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        60
      ]
    },
    {
      "parameters": {
        "fileName": "=historique_demandes.csv",
        "options": {}
      },
      "id": "node_14_write",
      "name": "ğŸ“ Ã‰crire CSV",
      "type": "n8n-nodes-base.writeBinaryFile",
      "typeVersion": 1,
      "position": [
        820,
        60
      ]
    },
    {
      "parameters": {
        "operation": "completion",
        "completionTitle": "={{ $('ğŸ“ Fusionner DonnÃ©es').first().json.classe === 'Urgence' ? 'ğŸš¨ Demande urgente transmise !' : $('ğŸ“ Fusionner DonnÃ©es').first().json.classe === 'RÃ©clamation' ? 'âš ï¸ RÃ©clamation enregistrÃ©e !' : $('ğŸ“ Fusionner DonnÃ©es').first().json.classe === 'Commande' ? 'ğŸ›’ Commande enregistrÃ©e !' : 'âœ… Demande bien reÃ§ue !' }}",
        "completionMessage": "={{ 'Bonjour ' + $('ğŸ“ Fusionner DonnÃ©es').first().json.nom + ' !\\n\\n' + $('ğŸ“ Fusionner DonnÃ©es').first().json.reponse_client + '\\n\\nRÃ©fÃ©rence : ' + $('ğŸ“ Fusionner DonnÃ©es').first().json.req_id + '\\nClasse ML : ' + $('ğŸ“ Fusionner DonnÃ©es').first().json.classe + ' (' + $('ğŸ“ Fusionner DonnÃ©es').first().json.confiance + '%)' }}",
        "options": {}
      },
      "id": "node_15_form_end",
      "name": "âœ… Confirmation Client",
      "type": "n8n-nodes-base.form",
      "typeVersion": 2.2,
      "position": [
        1060,
        0
      ]
    }
  ],
  "connections": {
    "ğŸ“¥ Formulaire Client": {
      "main": [
        [
          {
            "node": "ğŸ”§ Extraire Champs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ”§ Extraire Champs": {
      "main": [
        [
          {
            "node": "ğŸ¤– Classifier ML",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– Classifier ML": {
      "main": [
        [
          {
            "node": "ğŸ“ Fusionner DonnÃ©es",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Fusionner DonnÃ©es": {
      "main": [
        [
          {
            "node": "ğŸš¨ Urgence ?",
            "type": "main",
            "index": 0
          },
          {
            "node": "âš ï¸ RÃ©clamation ?",
            "type": "main",
            "index": 0
          },
          {
            "node": "ğŸ›’ Commande ?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ Urgence ?": {
      "main": [
        [
          {
            "node": "ğŸš¨ PrÃ©parer Urgence",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "âš ï¸ RÃ©clamation ?": {
      "main": [
        [
          {
            "node": "âš ï¸ PrÃ©parer RÃ©clamation",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "ğŸ›’ Commande ?": {
      "main": [
        [
          {
            "node": "ğŸ›’ PrÃ©parer Commande",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "â„¹ï¸ PrÃ©parer Information",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ PrÃ©parer Urgence": {
      "main": [
        [
          {
            "node": "ğŸ“§ Email Responsable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "âš ï¸ PrÃ©parer RÃ©clamation": {
      "main": [
        [
          {
            "node": "ğŸ“§ Email Responsable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ›’ PrÃ©parer Commande": {
      "main": [
        [
          {
            "node": "ğŸ“§ Email Responsable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â„¹ï¸ PrÃ©parer Information": {
      "main": [
        [
          {
            "node": "ğŸ’¾ PrÃ©parer CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Email Responsable": {
      "main": [
        [
          {
            "node": "ğŸ’¾ PrÃ©parer CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ PrÃ©parer CSV": {
      "main": [
        [
          {
            "node": "ğŸ“ Ã‰crire CSV",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Ã‰crire CSV": {
      "main": [
        [
          {
            "node": "âœ… Confirmation Client",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true
  },
  "tags": [
    "PME",
    "Dakar",
    "ML",
    "Simple"
  ]
}